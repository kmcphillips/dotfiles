#!/usr/bin/env ruby

def exit_with(message)
  puts message
  exit 1
end

def usage
  puts "Usage: shopify_rubocop_run [a|autocorrect|auto|correct]"
  exit 1
end

exit_with "This script only works in Spin" unless ENV["SPIN"]

action = if ARGV.count == 1
  if %w[a autocorrect auto correct auto-correct auto_correct].include?(ARGV[0])
    :autocorrect
  else
    usage
  end
else
  :check
end

require "fileutils"

root_path = "#{ Dir.home }/src/github.com/Shopify/shopify"
rubocop_todo_path = "#{ root_path }/.rubocop_todo.yml"
run_file_path = "#{ root_path }/tmp/rubocop_run"

exit_with "The file of filenames does not exist:\n#{run_file_path}" unless File.exist?(run_file_path)

Dir.chdir(root_path) do
  file_paths = File.readlines(run_file_path).map do |line|
    next if line.strip.empty?
    line = line.strip
    next if line.start_with?("#")
    line = line
      .gsub(/\s*\-\s+/, "")
      .gsub(/\A'(.*)'\z/, '\1')
      .gsub(/\A\"(.*)\"\z/, '\1')

    next unless File.exist?(line)
    line
  end.compact.sort.uniq

  exit_with "No files to run" if file_paths.empty?

  case action
  when :autocorrect
    puts "Running rubocop autocorrect on #{file_paths.count} files"
    system("bundle exec rubocop --autocorrect #{file_paths.join(" ")}")
  when :check
    puts "Running rubocop on #{file_paths.count} files"
    system("bundle exec rubocop #{file_paths.join(" ")}")
  end
end

