#!/usr/bin/env ruby
require 'httparty'
require 'pry'
require 'term/ansicolor'

include Term::ANSIColor

class CircleCiProject
  attr_reader :project, :token

  def initialize(project:, token:)
    @project = project
    @token = token

    raise "Set ENV['CIRCLE_CI_TOKEN'] containing your Circle CI token" if !token || token == ''

    @response = HTTParty.get(url).parsed_response
  end

  def url
    "https://circleci.com/gh/#{ project }.cc.xml?ccmenu=cc.xml&circle-token=#{ token }"
  end

  def status_for_console
    status_message = if failure?
      red('Red')
    elsif success?
      green('Green')
    else
      status
    end

    "#{ project }: #{ status_message } / #{ activity }"
  end

  def status
    @response["Projects"]["Project"]["lastBuildStatus"]
  end

  def activity
    @response["Projects"]["Project"]["activity"]
  end

  def failure?
    status == 'Failure'
  end

  def success?
    status == 'Success'
  end

end

puts CircleCiProject.new(project: 'Shopify/shopify', token: ENV["CIRCLE_CI_TOKEN"]).status_for_console
