#!/usr/bin/env ruby

require 'fileutils'

snapshot_path = "/home/vagrant/src/shopify/tmp/db_snapshot"

case ARGV[0]
when "dump"
  databases = `mysql -uroot -e "show databases" | grep shopify_dev`.split("\n")

  puts "Working in: #{ snapshot_path }"
  FileUtils.rm_rf(snapshot_path)
  FileUtils.mkdir(snapshot_path)

  databases.each do |database|
    cmd = "mysqldump -uroot #{ database } > #{ snapshot_path }/#{ database }.sql"

    `#{ cmd }`

    puts "  Dumped: #{ database }.sql"
  end

when "load"
  unless File.exists?(snapshot_path)
    puts "Unable to find snapshot at: #{ snapshot_path }"
    exit 1
  end

  files = Dir.glob("#{ snapshot_path }/*.sql")

  files.each do |filename|
    database = filename.split("/").last.gsub(/\.sql/, "")

    cmd = "mysql -uroot -e \"drop database #{ database }\""
    `#{ cmd }`

    cmd = "mysql -uroot -e \"create database #{ database }\""
    `#{ cmd }`

    cmd = "mysql -uroot #{ database } < #{ filename }"
    `#{ cmd }`

    puts "  Loaded: #{ database }"
  end

else
  puts "USAGE: shopify_db_snapshot dump|load"
  exit 1
end

